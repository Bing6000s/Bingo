"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("./helper.cjs"),g=async(u,r,a)=>{let e=r;e.length===0&&(await u.listCollections()).forEach(s=>e.push(s.path));const t=e.map(i=>h(u,i,a)),l=await Promise.all(t);return Object.assign({},...l)},y=async(u,r,a,e)=>{try{let t={};t[r]={};const s=[await u.collection(r).doc(a).get()];for(const c of s){const f=await c.ref.listCollections();if(t[r][c.id]=c.data()||{},e!=null&&e.refs){for(const n of e==null?void 0:e.refs)if(n.indexOf(".")>-1)o.traverseObjects(t,d=>{var C;return((C=d.constructor)==null?void 0:C.name)!=="DocumentReference"?null:o.getPath(d)});else if(t[r][c.id][n])if(Array.isArray(t[r][c.id][n]))for(let d of t[r][c.id][n])t[r][c.id][n]=o.getPath(d);else typeof t[r][c.id][n].path=="string"&&(t[r][c.id][n]=t[r][c.id][n].path)}if(f.length>0){t[r][c.id].subCollection={};for(const n of f){const d=await h(u,`${r}/${a}/${n.id}`,e);t[r][c.id].subCollection={...t[r][c.id].subCollection,...d}}}}return t}catch(t){throw console.error(t),new Error(t.message)}},b=async(u,r,a,e)=>{const t=await r.ref.listCollections();let l=Object.assign({},r.data());if(e!=null&&e.refs){for(const s of e==null?void 0:e.refs)if(s.indexOf(".")>-1)o.traverseObjects(l,c=>{var f;return((f=c.constructor)==null?void 0:f.name)!=="DocumentReference"?null:o.getPath(c)});else if(l[s])if(Array.isArray(l[s]))for(let c of l[s])l[s]=o.getPath(c);else typeof l[s].path=="string"&&(l[s]=l[s].path)}if(t.length>0){l.subCollection={};const s={...e};s!=null&&s.queryCollection&&delete s.queryCollection;for(const c of t){const f=await h(u,`${a}/${r.id}/${c.id}`,s);l.subCollection={...l.subCollection,...f}}}let i={};return i[r.id]=l,i},h=async(u,r,a)=>{try{let e={};e[r]={};const t=u.collection(r),l=(a==null?void 0:a.queryCollection)!=null?await a.queryCollection(t):await t.get(),s=(((a==null?void 0:a.docsFromEachCollection)??0)>0?l.docs.slice(0,a==null?void 0:a.docsFromEachCollection):l.docs).map(f=>b(u,f,t.path,a));return(await Promise.all(s)).forEach(f=>{e[r]=Object.assign(e[r],f)}),e}catch(e){throw console.error(e),new Error(e.message)}};exports.backUpDocRef=b;exports.backupFromDocService=y;exports.backupService=h;exports.getAllCollectionsService=g;
